%h2 Create New Experiment

%h3 Project Details
%p
.somecontainer
  = label_tag "project_select", "<abbr title='required'>*</abbr> Select a project".html_safe, {class:"string select control-label"}
  = select_tag "project_select", options_from_collection_for_select(@projects, :id, :name, @experiment.project_id), :prompt => "----"
  = link_to "Create New Project", new_project_path

.project_display
  = label_tag "pid", "Project ID: ", { :id=>"pid" }
  = label_tag "description", "Description: " , { :id=>"description" }
  = label_tag "date_created", "Date Created: " , { :id=>"date_created" }
  = label_tag "funded_by", "Funded By: ", { :id=>"funded_by" }
  = label_tag "supervisor", "Supervisor: " , { :id=>"supervisor" }

<hr/>
%h3 Experiment Details
- if @instrument
  = label_tag "Instrument", "Instrument: #{@instrument}"
- else
  = label_tag "Instrument", "Instrument: Unknown"

%p
= simple_form_for(@experiment) do |f|
  = f.input :project_id, :as => :hidden, :input_html => { :value => @project_id }
  = f.input :instrument, :as => :hidden, :input_html => { :value => @instrument }
  = f.input :expt_name, :label => "Experiment Name"
  = f.input :lab_book_no, label: "Lab Book No. (If you don't have one, please enter 'TBA')"
  = f.input :page_no, :label => "Page No."
  = f.input :cell_type_or_tissue, :label => "Cell Type or Tissue"
  = f.input :expt_type, :label => "Experiment Type", :collection => ["Fixed", "Live"]
  <hr/>
  %h4 Apparatus
  <br/>
  = f.input :slides
  = f.input :dishes
  = f.input :multiwell_chambers, :label => "Multiwell Chambers"
  = f.input :other
  = f.input :other_text, :label => "Other (Specify)"
  <hr/>
  = f.input :has_fluorescent_proteins, label:"Fluorescent proteins"
  = f.input :fluorescent_protein_ids, label: "Fluorescent Proteins (Specify)", input_html:{value:""}
  = f.input :has_specific_dyes, label: "Specific dyes"
  = f.input :specific_dye_ids, label: "Specific Dyes (Specify)", input_html:{value:""}
  = f.input :immunofluorescence

  .form-actions
    = f.submit "Create Experiment", :class => "btn btn-primary", :id => "experiment_submit"
    = link_to 'Save and Download Data', root_path, :class => "btn", :disabled => true
    = link_to 'Cancel', cancel_experiments_path, :class => "btn"

:javascript
  core = #{@core_proteins};
  proteins = #{@proteins};
  dyes = #{@dyes};
  $('#experiment_fluorescent_protein_ids').val(proteins);
  $('#experiment_fluorescent_protein_ids').select2({
    createSearchChoice:
      function(term, data) {
        if ($(data).filter(function() {
          return this.name.localeCompare(term)===0;
        }).length===0){
          return {id:'<<<'+term+'>>>', name:term};
        }
      },
    width: "400px",
    multiple:true,
    data: {results: core, text:'name'},
    formatSelection: format,
    formatResult: format,
    initSelection:
      function (element, callback) {
        $('#experiment_fluorescent_protein_ids').val('');
        callback(proteins);
      }

  });
  function format(item) { return item.name; };

  $('#experiment_specific_dye_ids').val(dyes);
  $('#experiment_specific_dye_ids').select2({
    createSearchChoice:
      function(term, data) {
        if ($(data).filter(function() {
          return this.name.localeCompare(term)===0;
        }).length===0){
          return {id:'<<<'+term+'>>>', name:term};
        }
      },
    width: "400px",
    multiple:true,
    data: {results: [], text:'name'},
    formatSelection: format,
    formatResult: format,
    initSelection:
      function (element, callback) {
        $('#experiment_specific_dye_ids').val('');
        callback(dyes);
      }

  });

